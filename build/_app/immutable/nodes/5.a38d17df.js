import{s as $e,a as Ne,e as De,M as et,d as W,c as Pe,i as Ue,w as X,o as tt,p as z,f as fe,g as pe,h as ge,j as Z,r as x,u as ot,V as $,t as v}from"../chunks/scheduler.67abc04a.js";import{S as st,i as nt,a as te,t as ce,c as at,f as ee,b as ke,d as Me,m as Ie,e as Te,g as lt}from"../chunks/index.89481181.js";import{g as rt}from"../chunks/globals.7f7f1b26.js";import{a as B}from"../chunks/Toaster.svelte_svelte_type_style_lang.9328e92b.js";import{g as Ce}from"../chunks/navigation.569133cb.js";import{p as it}from"../chunks/stores.45050c08.js";import{e as me,h as Ee,a as qe,L as ct,O as ut,g as He,f as Le,m as ft,j as pt,W as gt,c as mt}from"../chunks/index.4add80fc.js";import{v as Ge,s as Je,c as je,d as dt}from"../chunks/index.496e36ff.js";import{i as ht,e as _t,f as Ve}from"../chunks/index.fc4f5c22.js";import{c as wt,b as de,p as he,w as yt,v as We,x as St,y as bt,o as kt}from"../chunks/Tooltip.c7607fa1.js";import{q as Mt,a as It}from"../chunks/index.46ca4376.js";import{d as Tt}from"../chunks/index.fef6b970.js";import{N as Ct,M as Et,a as Nt,b as Pt,R as At}from"../chunks/index.dae629b9.js";const{document:Re}=rt;function Fe(o){var ye;let I,t,s,f,c,u,_,oe,K,se,P,w,Q,A,R,T,S,ne,C,H,J,F,U;t=new Ct({props:{title:o[10],shareEnabled:o[13].length>0,initNewChat:o[27],tags:o[9],addTag:o[23],deleteTag:o[24]}});function r(n){o[28](n)}let a={};o[0]!==void 0&&(a.selectedModels=o[0]),_=new Et({props:a}),z.push(()=>ee(_,"selectedModels",r));function Ae(n){o[29](n)}function j(n){o[30](n)}function Oe(n){o[31](n)}let Y={chatId:o[15],selectedModels:o[0],selectedModelfiles:o[8],processing:o[4],bottomPadding:o[12].length>0,sendPrompt:o[19],continueGeneration:o[21],regenerateResponse:o[22]};o[1]!==void 0&&(Y.history=o[1]),o[13]!==void 0&&(Y.messages=o[13]),o[3]!==void 0&&(Y.autoScroll=o[3]),w=new Nt({props:Y}),z.push(()=>ee(w,"history",Ae)),z.push(()=>ee(w,"messages",j)),z.push(()=>ee(w,"autoScroll",Oe));function _e(n){o[34](n)}function we(n){o[35](n)}function ve(n){o[36](n)}let ae={suggestionPrompts:((ye=o[7])==null?void 0:ye.suggestionPrompts)??o[17].default_prompt_suggestions,messages:o[13],submitPrompt:o[18],stopResponse:o[20]};return o[12]!==void 0&&(ae.files=o[12]),o[11]!==void 0&&(ae.prompt=o[11]),o[3]!==void 0&&(ae.autoScroll=o[3]),S=new Pt({props:ae}),z.push(()=>ee(S,"files",_e)),z.push(()=>ee(S,"prompt",we)),z.push(()=>ee(S,"autoScroll",ve)),{c(){I=fe("div"),ke(t.$$.fragment),s=Ne(),f=fe("div"),c=fe("div"),u=fe("div"),ke(_.$$.fragment),se=Ne(),P=fe("div"),ke(w.$$.fragment),T=Ne(),ke(S.$$.fragment),this.h()},l(n){I=pe(n,"DIV",{class:!0});var g=ge(I);Me(t.$$.fragment,g),s=Pe(g),f=pe(g,"DIV",{class:!0});var E=ge(f);c=pe(E,"DIV",{class:!0,id:!0});var V=ge(c);u=pe(V,"DIV",{class:!0});var N=ge(u);Me(_.$$.fragment,N),N.forEach(W),se=Pe(V),P=pe(V,"DIV",{class:!0});var D=ge(P);Me(w.$$.fragment,D),D.forEach(W),V.forEach(W),T=Pe(E),Me(S.$$.fragment,E),E.forEach(W),g.forEach(W),this.h()},h(){var n;Z(u,"class",K=(((n=o[14])==null?void 0:n.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"),Z(P,"class","h-full w-full flex flex-col py-8"),Z(c,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),Z(c,"id","messages-container"),Z(f,"class","flex flex-col flex-auto"),Z(I,"class","min-h-screen max-h-screen w-full flex flex-col")},m(n,g){Ue(n,I,g),Ie(t,I,null),x(I,s),x(I,f),x(f,c),x(c,u),Ie(_,u,null),x(c,se),x(c,P),Ie(w,P,null),o[32](c),x(f,T),Ie(S,f,null),J=!0,F||(U=ot(c,"scroll",o[33]),F=!0)},p(n,g){var Se,be;const E={};g[0]&1024&&(E.title=n[10]),g[0]&8192&&(E.shareEnabled=n[13].length>0),g[0]&64&&(E.initNewChat=n[27]),g[0]&512&&(E.tags=n[9]),t.$set(E);const V={};!oe&&g[0]&1&&(oe=!0,V.selectedModels=n[0],$(()=>oe=!1)),_.$set(V),(!J||g[0]&16384&&K!==(K=(((Se=n[14])==null?void 0:Se.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"))&&Z(u,"class",K);const N={};g[0]&32768&&(N.chatId=n[15]),g[0]&1&&(N.selectedModels=n[0]),g[0]&256&&(N.selectedModelfiles=n[8]),g[0]&16&&(N.processing=n[4]),g[0]&4096&&(N.bottomPadding=n[12].length>0),!Q&&g[0]&2&&(Q=!0,N.history=n[1],$(()=>Q=!1)),!A&&g[0]&8192&&(A=!0,N.messages=n[13],$(()=>A=!1)),!R&&g[0]&8&&(R=!0,N.autoScroll=n[3],$(()=>R=!1)),w.$set(N);const D={};g[0]&131200&&(D.suggestionPrompts=((be=n[7])==null?void 0:be.suggestionPrompts)??n[17].default_prompt_suggestions),g[0]&8192&&(D.messages=n[13]),!ne&&g[0]&4096&&(ne=!0,D.files=n[12],$(()=>ne=!1)),!C&&g[0]&2048&&(C=!0,D.prompt=n[11],$(()=>C=!1)),!H&&g[0]&8&&(H=!0,D.autoScroll=n[3],$(()=>H=!1)),S.$set(D)},i(n){J||(te(t.$$.fragment,n),te(_.$$.fragment,n),te(w.$$.fragment,n),te(S.$$.fragment,n),J=!0)},o(n){ce(t.$$.fragment,n),ce(_.$$.fragment,n),ce(w.$$.fragment,n),ce(S.$$.fragment,n),J=!1},d(n){n&&W(I),Te(t),Te(_),Te(w),o[32](null),Te(S),F=!1,U()}}}function Ot(o){let I,t,s,f;Re.title=I=`
		`+(o[10]?`${o[10].length>30?`${o[10].slice(0,30)}...`:o[10]} | ${o[16]}`:`${o[16]}`)+`
	`;let c=o[2]&&Fe(o);return{c(){t=Ne(),c&&c.c(),s=De()},l(u){et("svelte-1123lr8",Re.head).forEach(W),t=Pe(u),c&&c.l(u),s=De()},m(u,_){Ue(u,t,_),c&&c.m(u,_),Ue(u,s,_),f=!0},p(u,_){(!f||_[0]&66560)&&I!==(I=`
		`+(u[10]?`${u[10].length>30?`${u[10].slice(0,30)}...`:u[10]} | ${u[16]}`:`${u[16]}`)+`
	`)&&(Re.title=I),u[2]?c?(c.p(u,_),_[0]&4&&te(c,1)):(c=Fe(u),c.c(),te(c,1),c.m(s.parentNode,s)):c&&(lt(),ce(c,1,1,()=>{c=null}),at())},i(u){f||(te(c),f=!0)},o(u){ce(c),f=!1},d(u){u&&(W(t),W(s)),c&&c.d(u)}}}function vt(o,I,t){let s,f,c,u,_,oe,K;X(o,Le,e=>t(14,s=e)),X(o,Ee,e=>t(15,f=e)),X(o,ft,e=>t(39,c=e)),X(o,it,e=>t(25,u=e)),X(o,pt,e=>t(26,_=e)),X(o,gt,e=>t(16,oe=e)),X(o,mt,e=>t(17,K=e));let se=!1,P=!1,w=!0,Q="",A,R=null,T=[""],S=null,ne={},C=null,H=[],J="",F="",U=[],r=[],a={messages:{},currentId:null};const Ae=async()=>{if(await Ee.set(u.params.id),C=await kt(localStorage.token,f).catch(async e=>(await Ce("/"),null)),C){t(9,H=await E());const e=C.chat;if(e){console.log(e),t(0,T=((e==null?void 0:e.models)??void 0)!==void 0?e.models:[e.models??""]),t(1,a=((e==null?void 0:e.history)??void 0)!==void 0?e.history:dt(e.messages)),t(10,J=e.title);let i=JSON.parse(localStorage.getItem("settings")??"{}");return await Le.set({...i,system:e.system??i.system,options:e.options??i.options}),t(3,w=!0),await v(),r.length>0&&t(1,a.messages[r.at(-1).id].done=!0,a),await v(),!0}else return null}},j=()=>{t(5,A.scrollTop=A.scrollHeight,A)},Oe=async(e,i=null)=>{if(console.log("submitPrompt",f),T.includes(""))B.error("Model not selected");else if(r.length!=0&&r.at(-1).done!=!0)console.log("wait");else if(U.length>0&&U.filter(h=>h.upload_status===!1).length>0)B.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let h=Ge(),b={id:h,parentId:r.length!==0?r.at(-1).id:null,childrenIds:[],role:"user",user:i??void 0,content:e,files:U.length>0?U:void 0,timestamp:Math.floor(Date.now()/1e3)};t(1,a.messages[h]=b,a),t(1,a.currentId=h,a),r.length!==0&&a.messages[r.at(-1).id].childrenIds.push(h),await v(),r.length==1&&(s.saveChatHistory??!0?(C=await wt(localStorage.token,{id:f,title:"New Chat",models:T,system:s.system??void 0,options:{...s.options??{}},messages:r,history:a,timestamp:Date.now()}),await me.set(await de(localStorage.token)),await Ee.set(C.id)):await Ee.set("local"),await v()),t(11,F=""),t(12,U=[]),await Y(e,h)}},Y=async(e,i)=>{const h=JSON.parse(JSON.stringify(f)),b=r.filter(l=>(l==null?void 0:l.files)??null).map(l=>l.files.filter(m=>m.type==="doc"||m.type==="collection")).flat(1);if(console.log(b),b.length>0){t(4,Q="Reading");const l=a.messages[i].content;let m=await Promise.all(b.map(async M=>M.type==="collection"?await Mt(localStorage.token,M.collection_names,l).catch(q=>(console.log(q),null)):await It(localStorage.token,M.collection_name,l).catch(q=>(console.log(q),null))));m=m.filter(M=>M);const k=m.reduce((M,q,le,d)=>`${M}${q.documents.join(" ")}
`,"");console.log(k),t(1,a.messages[i].raContent=await At(localStorage.token,k,l),a),t(1,a.messages[i].contexts=m,a),await v(),t(4,Q="")}await Promise.all(T.map(async l=>{const m=c.filter(k=>k.id===l).at(0);if(m){let k=Ge(),M={parentId:i,id:k,childrenIds:[],role:"assistant",content:"",model:m.id,timestamp:Math.floor(Date.now()/1e3)};t(1,a.messages[k]=M,a),t(1,a.currentId=k,a),i!==null&&t(1,a.messages[i].childrenIds=[...a.messages[i].childrenIds,k],a),m!=null&&m.external?await we(m,e,k,h):m&&await _e(m,e,k,h)}else B.error(`Model ${l} not found`)})),await me.set(await de(localStorage.token))},_e=async(e,i,h,b)=>{var le;e=e.id;const l=a.messages[h];await v(),j();const m=[s.system?{role:"system",content:s.system}:void 0,...r].filter(d=>d).map((d,L,re)=>({role:d.role,content:re.length-2!==L?d.content:(d==null?void 0:d.raContent)??d.content,...d.files&&{images:d.files.filter(O=>O.type==="image").map(O=>O.url.slice(O.url.indexOf(",")+1))}}));let k=-1;m.forEach((d,L)=>{d.images&&(k=L)}),m.forEach((d,L)=>{L!==k&&delete d.images});const[M,q]=await ht(localStorage.token,{model:e,messages:m,options:{...s.options??{}},format:s.requestFormat??void 0,keep_alive:s.keepAlive??void 0});if(M&&M.ok){console.log("controller",q);const d=M.body.pipeThrough(new TextDecoderStream).pipeThrough(Je(`
`)).getReader();for(;;){const{value:L,done:re}=await d.read();if(re||P||b!==f){l.done=!0,t(13,r),t(1,a),P&&(q.abort("User: Stop Response"),await Ve(localStorage.token,R)),t(6,R=null);break}try{let O=L.split(`
`);for(const p of O)if(p!==""){console.log(p);let y=JSON.parse(p);if("detail"in y)throw y;if("id"in y)console.log(y),t(6,R=y.id);else if(y.done==!1){if(l.content==""&&y.message.content==`
`)continue;l.content+=y.message.content,t(13,r),t(1,a)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=y.context??null,l.info={total_duration:y.total_duration,load_duration:y.load_duration,sample_count:y.sample_count,sample_duration:y.sample_duration,prompt_eval_count:y.prompt_eval_count,prompt_eval_duration:y.prompt_eval_duration,eval_count:y.eval_count,eval_duration:y.eval_duration},t(13,r),t(1,a),s.notificationEnabled&&!document.hasFocus()){const ue=new Notification(S?`${S.title.charAt(0).toUpperCase()+S.title.slice(1)}`:`${e}`,{body:l.content,icon:(S==null?void 0:S.imageUrl)??`${qe}/static/favicon.png`})}s.responseAutoCopy&&je(l.content),s.responseAutoPlayback&&(await v(),(le=document.getElementById(`speak-button-${l.id}`))==null||le.click())}}}catch(O){console.log(O),"detail"in O&&B.error(O.detail);break}w&&j()}f==b&&(s.saveChatHistory??!0)&&(C=await he(localStorage.token,b,{messages:r,history:a}),await me.set(await de(localStorage.token)))}else{if(M!==null){const d=await M.json();console.log(d),"detail"in d?(B.error(d.detail),l.content=d.detail):(B.error(d.error),l.content=d.error)}else B.error("Uh-oh! There was an issue connecting to Ollama."),l.content="Uh-oh! There was an issue connecting to Ollama.";l.error=!0,l.content="Uh-oh! There was an issue connecting to Ollama.",l.done=!0,t(13,r),t(1,a)}P=!1,await v(),w&&j(),r.length==2&&r.at(1).content!==""&&(window.history.replaceState(a.state,"",`/c/${b}`),await n(b,i))},we=async(e,i,h,b)=>{var k,M,q,le,d,L,re,O;const l=a.messages[h];j();const m=await Tt(localStorage.token,{model:e.id,stream:!0,messages:[s.system?{role:"system",content:s.system}:void 0,...r].filter(p=>p).map((p,y,ue)=>{var ie;return{role:p.role,...((ie=p.files)==null?void 0:ie.filter(G=>G.type==="image").length)>0?{content:[{type:"text",text:ue.length-1!==y?p.content:(p==null?void 0:p.raContent)??p.content},...p.files.filter(G=>G.type==="image").map(G=>({type:"image_url",image_url:{url:G.url}}))]}:{content:ue.length-1!==y?p.content:(p==null?void 0:p.raContent)??p.content}}}),seed:((k=s==null?void 0:s.options)==null?void 0:k.seed)??void 0,stop:((M=s==null?void 0:s.options)==null?void 0:M.stop)??void 0,temperature:((q=s==null?void 0:s.options)==null?void 0:q.temperature)??void 0,top_p:((le=s==null?void 0:s.options)==null?void 0:le.top_p)??void 0,num_ctx:((d=s==null?void 0:s.options)==null?void 0:d.num_ctx)??void 0,frequency_penalty:((L=s==null?void 0:s.options)==null?void 0:L.repeat_penalty)??void 0,max_tokens:((re=s==null?void 0:s.options)==null?void 0:re.num_predict)??void 0},e.source==="litellm"?`${ct}/v1`:`${ut}`);if(m&&m.ok){const p=m.body.pipeThrough(new TextDecoderStream).pipeThrough(Je(`
`)).getReader();for(;;){const{value:y,done:ue}=await p.read();if(ue||P||b!==f){l.done=!0,t(13,r),t(1,a);break}try{let ie=y.split(`
`);for(const G of ie)if(G!=="")if(console.log(G),G==="data: [DONE]")l.done=!0,t(13,r),t(1,a);else{let Be=JSON.parse(G.replace(/^data: /,""));if(console.log(Be),l.content==""&&Be.choices[0].delta.content==`
`)continue;l.content+=Be.choices[0].delta.content??"",t(13,r),t(1,a)}}catch(ie){console.log(ie)}s.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:l.content,icon:`${qe}/static/favicon.png`}),s.responseAutoCopy&&je(l.content),s.responseAutoPlayback&&(await v(),(O=document.getElementById(`speak-button-${l.id}`))==null||O.click()),w&&j()}f==b&&(s.saveChatHistory??!0)&&(C=await he(localStorage.token,b,{messages:r,history:a}),await me.set(await de(localStorage.token)))}else{if(m!==null){const p=await m.json();console.log(p),"detail"in p?(B.error(p.detail),l.content=p.detail):"message"in p.error?(B.error(p.error.message),l.content=p.error.message):(B.error(p.error),l.content=p.error)}else B.error(`Uh-oh! There was an issue connecting to ${e}.`),l.content=`Uh-oh! There was an issue connecting to ${e}.`;l.error=!0,l.content=`Uh-oh! There was an issue connecting to ${e}.`,l.done=!0,t(13,r),t(1,a)}P=!1,await v(),w&&j(),r.length==2&&(window.history.replaceState(a.state,"",`/c/${b}`),await g(b,i))},ve=()=>{P=!0,console.log("stopResponse")},ae=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(f));if(r.length!=0&&r.at(-1).done==!0){const i=a.messages[a.currentId];i.done=!1,await v();const h=c.filter(b=>b.id===i.model).at(0);h&&(h!=null&&h.external?await we(h,a.messages[i.parentId].content,i.id,e):await _e(h,a.messages[i.parentId].content,i.id,e))}else B.error(`Model ${modelId} not found`)},ye=async()=>{if(console.log("regenerateResponse"),r.length!=0&&r.at(-1).done==!0){r.splice(r.length-1,1),t(13,r),t(1,a);let e=r.at(-1),i=e.content;await Y(i,e.id)}},n=async(e,i)=>{if(s.titleAutoGenerate??!0){const h=await _t(localStorage.token,(s==null?void 0:s.titleGenerationPrompt)??"Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title': {{prompt}}",(s==null?void 0:s.titleAutoGenerateModel)??T[0],i);h&&await g(e,h)}else await g(e,`${i}`)},g=async(e,i)=>{e===f&&t(10,J=i),C=await he(localStorage.token,e,{title:i}),await me.set(await de(localStorage.token))},E=async()=>await bt(localStorage.token,f).catch(async e=>[]),V=async e=>{await yt(localStorage.token,f,e),t(9,H=await E()),C=await he(localStorage.token,f,{tags:H}),He.set(await We(localStorage.token))},N=async e=>{await St(localStorage.token,f,e),t(9,H=await E()),C=await he(localStorage.token,f,{tags:H}),He.set(await We(localStorage.token))};tt(async()=>{(s.saveChatHistory??!0)||await Ce("/")});const D=async()=>{R!==null&&(await Ve(localStorage.token,R),t(6,R=null)),Ce("/")};function Se(e){T=e,t(0,T)}function be(e){a=e,t(1,a)}function Ye(e){r=e,t(13,r),t(1,a)}function ze(e){w=e,t(3,w)}function Ke(e){z[e?"unshift":"push"](()=>{A=e,t(5,A)})}const Qe=e=>{t(3,w=A.scrollHeight-A.scrollTop<=A.clientHeight+50)};function Xe(e){U=e,t(12,U)}function Ze(e){F=e,t(11,F)}function xe(e){w=e,t(3,w)}return o.$$.update=()=>{if(o.$$.dirty[0]&67108865&&t(7,S=T.length===1&&_.filter(e=>e.tagName===T[0]).length>0?_.filter(e=>e.tagName===T[0])[0]:null),o.$$.dirty[0]&67108865&&t(8,ne=T.reduce((e,i,h,b)=>{var m;const l=((m=_.filter(k=>k.tagName===i))==null?void 0:m.at(0))??void 0;return{...e,...l&&{[i]:l}}},{})),o.$$.dirty[0]&2)if(a.currentId!==null){let e=[],i=a.messages[a.currentId];for(;i!==null;)e.unshift({...i}),i=i.parentId!==null?a.messages[i.parentId]:null;t(13,r=e)}else t(13,r=[]);o.$$.dirty[0]&33554432&&u.params.id&&(async()=>{if(await Ae()){await v(),t(2,se=!0),window.setTimeout(()=>j(),0);const e=document.getElementById("chat-textarea");e==null||e.focus()}else await Ce("/")})()},[T,a,se,w,Q,A,R,S,ne,H,J,F,U,r,s,f,oe,K,Oe,Y,ve,ae,ye,V,N,u,_,D,Se,be,Ye,ze,Ke,Qe,Xe,Ze,xe]}class Yt extends st{constructor(I){super(),nt(this,I,vt,Ot,$e,{},null,[-1,-1])}}export{Yt as component};
