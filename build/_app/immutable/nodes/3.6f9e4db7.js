import{s as Ke,p as z,a as ke,f as fe,M as Qe,d as Y,c as Me,g as pe,h as ge,j as ee,i as De,r as te,u as Xe,V as oe,w as se,o as Ze,t as j}from"../chunks/scheduler.67abc04a.js";import{S as xe,i as $e,f as ne,b as Ce,d as Ie,m as Te,a as Ee,t as Pe,e as Ae}from"../chunks/index.89481181.js";import{g as et}from"../chunks/globals.7f7f1b26.js";import{a as v}from"../chunks/Toaster.svelte_svelte_type_style_lang.9328e92b.js";import"../chunks/singletons.5f7d0574.js";import{p as tt}from"../chunks/stores.45050c08.js";import{h as Ne,f as Ge,e as de,a as qe,L as ot,O as st,g as He,m as nt,c as at,j as lt,W as rt}from"../chunks/index.4add80fc.js";import{v as Le,s as Je,c as je}from"../chunks/index.496e36ff.js";import{e as it,f as Ve,h as ct,i as ut}from"../chunks/index.fc4f5c22.js";import{c as ft,b as me,p as he,w as pt,v as We,x as gt,y as dt}from"../chunks/Tooltip.c7607fa1.js";import{q as mt,a as ht}from"../chunks/index.46ca4376.js";import{d as _t}from"../chunks/index.fef6b970.js";import{N as wt,M as yt,a as St,b as bt,R as kt}from"../chunks/index.dae629b9.js";const{document:Ue}=et;function Mt(o){var Se;let K,t,s,d,L,S,I,A,N,q,k,Q,M,y,h,O,ae,U,b,X,V,R,r,l,ce;Ue.title=K=`
		`+(o[8]?`${o[8].length>30?`${o[8].slice(0,30)}...`:o[8]} | ${o[15]}`:`${o[15]}`)+`
	`,d=new wt({props:{title:o[8],shareEnabled:o[11].length>0,initNewChat:o[16],tags:o[7],addTag:o[22],deleteTag:o[23]}});function W(n){o[25](n)}let _e={};o[0]!==void 0&&(_e.selectedModels=o[0]),N=new yt({props:_e}),z.push(()=>ne(N,"selectedModels",W));function ue(n){o[26](n)}function we(n){o[27](n)}function ye(n){o[28](n)}let le={chatId:o[13],selectedModels:o[0],selectedModelfiles:o[6],processing:o[3],bottomPadding:o[10].length>0,sendPrompt:o[18],continueGeneration:o[21],regenerateResponse:o[20]};o[1]!==void 0&&(le.history=o[1]),o[11]!==void 0&&(le.messages=o[11]),o[2]!==void 0&&(le.autoScroll=o[2]),y=new St({props:le}),z.push(()=>ne(y,"history",ue)),z.push(()=>ne(y,"messages",we)),z.push(()=>ne(y,"autoScroll",ye));function Oe(n){o[31](n)}function Re(n){o[32](n)}function Be(n){o[33](n)}let Z={suggestionPrompts:((Se=o[5])==null?void 0:Se.suggestionPrompts)??o[14].default_prompt_suggestions,messages:o[11],submitPrompt:o[17],stopResponse:o[19]};return o[10]!==void 0&&(Z.files=o[10]),o[9]!==void 0&&(Z.prompt=o[9]),o[2]!==void 0&&(Z.autoScroll=o[2]),b=new bt({props:Z}),z.push(()=>ne(b,"files",Oe)),z.push(()=>ne(b,"prompt",Re)),z.push(()=>ne(b,"autoScroll",Be)),{c(){t=ke(),s=fe("div"),Ce(d.$$.fragment),L=ke(),S=fe("div"),I=fe("div"),A=fe("div"),Ce(N.$$.fragment),Q=ke(),M=fe("div"),Ce(y.$$.fragment),U=ke(),Ce(b.$$.fragment),this.h()},l(n){Qe("svelte-1123lr8",Ue.head).forEach(Y),t=Me(n),s=pe(n,"DIV",{class:!0});var D=ge(s);Ie(d.$$.fragment,D),L=Me(D),S=pe(D,"DIV",{class:!0});var J=ge(S);I=pe(J,"DIV",{class:!0,id:!0});var C=ge(I);A=pe(C,"DIV",{class:!0});var G=ge(A);Ie(N.$$.fragment,G),G.forEach(Y),Q=Me(C),M=pe(C,"DIV",{class:!0});var x=ge(M);Ie(y.$$.fragment,x),x.forEach(Y),C.forEach(Y),U=Me(J),Ie(b.$$.fragment,J),J.forEach(Y),D.forEach(Y),this.h()},h(){var n;ee(A,"class",k=(((n=o[12])==null?void 0:n.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"),ee(M,"class","h-full w-full flex flex-col py-8"),ee(I,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),ee(I,"id","messages-container"),ee(S,"class","flex flex-col flex-auto"),ee(s,"class","h-screen max-h-[100dvh] w-full flex flex-col")},m(n,g){De(n,t,g),De(n,s,g),Te(d,s,null),te(s,L),te(s,S),te(S,I),te(I,A),Te(N,A,null),te(I,Q),te(I,M),Te(y,M,null),o[29](I),te(S,U),Te(b,S,null),r=!0,l||(ce=Xe(I,"scroll",o[30]),l=!0)},p(n,g){var x,be;(!r||g[0]&33024)&&K!==(K=`
		`+(n[8]?`${n[8].length>30?`${n[8].slice(0,30)}...`:n[8]} | ${n[15]}`:`${n[15]}`)+`
	`)&&(Ue.title=K);const D={};g[0]&256&&(D.title=n[8]),g[0]&2048&&(D.shareEnabled=n[11].length>0),g[0]&128&&(D.tags=n[7]),d.$set(D);const J={};!q&&g[0]&1&&(q=!0,J.selectedModels=n[0],oe(()=>q=!1)),N.$set(J),(!r||g[0]&4096&&k!==(k=(((x=n[12])==null?void 0:x.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"))&&ee(A,"class",k);const C={};g[0]&8192&&(C.chatId=n[13]),g[0]&1&&(C.selectedModels=n[0]),g[0]&64&&(C.selectedModelfiles=n[6]),g[0]&8&&(C.processing=n[3]),g[0]&1024&&(C.bottomPadding=n[10].length>0),!h&&g[0]&2&&(h=!0,C.history=n[1],oe(()=>h=!1)),!O&&g[0]&2048&&(O=!0,C.messages=n[11],oe(()=>O=!1)),!ae&&g[0]&4&&(ae=!0,C.autoScroll=n[2],oe(()=>ae=!1)),y.$set(C);const G={};g[0]&16416&&(G.suggestionPrompts=((be=n[5])==null?void 0:be.suggestionPrompts)??n[14].default_prompt_suggestions),g[0]&2048&&(G.messages=n[11]),!X&&g[0]&1024&&(X=!0,G.files=n[10],oe(()=>X=!1)),!V&&g[0]&512&&(V=!0,G.prompt=n[9],oe(()=>V=!1)),!R&&g[0]&4&&(R=!0,G.autoScroll=n[2],oe(()=>R=!1)),b.$set(G)},i(n){r||(Ee(d.$$.fragment,n),Ee(N.$$.fragment,n),Ee(y.$$.fragment,n),Ee(b.$$.fragment,n),r=!0)},o(n){Pe(d.$$.fragment,n),Pe(N.$$.fragment,n),Pe(y.$$.fragment,n),Pe(b.$$.fragment,n),r=!1},d(n){n&&(Y(t),Y(s)),Ae(d),Ae(N),Ae(y),o[29](null),Ae(b),l=!1,ce()}}}function Ct(o,K,t){let s,d,L,S,I,A,N;se(o,Ge,e=>t(12,s=e)),se(o,Ne,e=>t(13,d=e)),se(o,nt,e=>t(37,L=e)),se(o,at,e=>t(14,S=e)),se(o,tt,e=>t(38,I=e)),se(o,lt,e=>t(24,A=e)),se(o,rt,e=>t(15,N=e));let q=!1,k=!0,Q="",M,y=null,h=[""],O=null,ae={},U=null,b=[],X="",V="",R=[],r=[],l={messages:{},currentId:null};Ze(async()=>{await ce()});const ce=async()=>{var u;y!==null&&(await Ve(localStorage.token,y),y=null),window.history.replaceState(l.state,"","/"),await Ne.set(""),t(2,k=!0),t(8,X=""),t(11,r=[]),t(1,l={messages:{},currentId:null}),I.url.searchParams.get("models")?t(0,h=(u=I.url.searchParams.get("models"))==null?void 0:u.split(",")):s!=null&&s.models?t(0,h=s==null?void 0:s.models):S!=null&&S.default_models?t(0,h=S==null?void 0:S.default_models.split(",")):t(0,h=[""]),t(0,h=h.map(m=>L.map(a=>a.id).includes(m)?m:""));let e=JSON.parse(localStorage.getItem("settings")??"{}");Ge.set({...e});const i=document.getElementById("chat-textarea");setTimeout(()=>i==null?void 0:i.focus(),0)},W=()=>{t(4,M.scrollTop=M.scrollHeight,M)},_e=async(e,i=null)=>{if(console.log("submitPrompt",d),t(0,h=h.map(u=>L.map(m=>m.id).includes(u)?u:"")),h.includes(""))v.error("Model not selected");else if(r.length!=0&&r.at(-1).done!=!0)console.log("wait");else if(R.length>0&&R.filter(u=>u.upload_status===!1).length>0)v.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let u=Le(),m={id:u,parentId:r.length!==0?r.at(-1).id:null,childrenIds:[],role:"user",user:i??void 0,content:e,files:R.length>0?R:void 0,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[u]=m,l),t(1,l.currentId=u,l),r.length!==0&&l.messages[r.at(-1).id].childrenIds.push(u),await j(),r.length==1&&(s.saveChatHistory??!0?(U=await ft(localStorage.token,{id:d,title:"New Chat",models:h,system:s.system??void 0,options:{...s.options??{}},messages:r,history:l,tags:[],timestamp:Date.now()}),await de.set(await me(localStorage.token)),await Ne.set(U.id)):await Ne.set("local"),await j()),t(9,V=""),t(10,R=[]),await ue(e,u)}},ue=async(e,i)=>{const u=JSON.parse(JSON.stringify(d)),m=r.filter(a=>(a==null?void 0:a.files)??null).map(a=>a.files.filter(f=>f.type==="doc"||f.type==="collection")).flat(1);if(console.log(m),m.length>0){t(3,Q="Reading");const a=l.messages[i].content;let f=await Promise.all(m.map(async E=>E.type==="collection"?await mt(localStorage.token,E.collection_names,a).catch(T=>(console.log(T),null)):await ht(localStorage.token,E.collection_name,a).catch(T=>(console.log(T),null))));f=f.filter(E=>E);const w=f.reduce((E,T,re,ie)=>`${E}${T.documents.join(" ")}
`,"");console.log(w),t(1,l.messages[i].raContent=await kt(localStorage.token,w,a),l),t(1,l.messages[i].contexts=f,l),await j(),t(3,Q="")}await Promise.all(h.map(async a=>{const f=L.filter(w=>w.id===a).at(0);if(f){let w=Le(),E={parentId:i,id:w,childrenIds:[],role:"assistant",content:"",model:f.id,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[w]=E,l),t(1,l.currentId=w,l),i!==null&&t(1,l.messages[i].childrenIds=[...l.messages[i].childrenIds,w],l),f!=null&&f.external?await ye(f,e,w,u):f&&await we(f,e,w,u)}else v.error(`Model ${a} not found`)})),await de.set(await me(localStorage.token))},we=async(e,i,u,m)=>{var ie;e=e.id;const a=l.messages[u];await j(),W();const f=[s.system?{role:"system",content:s.system}:void 0,...r].filter(p=>p).map((p,P,F)=>({role:p.role,content:F.length-2!==P?p.content:(p==null?void 0:p.raContent)??p.content,...p.files&&{images:p.files.filter(c=>c.type==="image").map(c=>c.url.slice(c.url.indexOf(",")+1))}}));let w=-1;f.forEach((p,P)=>{p.images&&(w=P)}),f.forEach((p,P)=>{P!==w&&delete p.images});async function E(p,P,F,c,B){return console.log("userPrompt: ",p),p.includes("Google Sheets")?(console.log("Google Sheets"),ct(P,{some_field:"Test"})):ut(P,{model:F,messages:c,options:{...B.options??{}},format:B.requestFormat??void 0,keep_alive:B.keepAlive??void 0})}const[T,re]=await E(i,localStorage.token,e,f,s);if(T&&T.ok){console.log("res",T),console.log("controller",re);const p=T.body.pipeThrough(new TextDecoderStream).pipeThrough(Je(`
`)).getReader();for(;;){const{value:P,done:F}=await p.read();if(F||q||m!==d){a.done=!0,t(11,r),t(1,l),q&&(re.abort("User: Stop Response"),await Ve(localStorage.token,y)),y=null;break}try{console.log("value",P);let c=P.split(`
`);for(const B of c)if(B!==""){console.log(B);let _=JSON.parse(B);if("detail"in _)throw _;if("id"in _)console.log(_),y=_.id;else if(_.done==!1){if(a.content==""&&_.message.content==`
`)continue;a.content+=_.message.content,t(11,r),t(1,l)}else{if(a.done=!0,i.includes("Google Sheets")?a.content="The desired changes are attached and can now be seen.":a.content==""&&(a.error=!0,a.content="Oops! No text generated from Ollama, Please try again."),a.context=_.context??null,a.info={total_duration:_.total_duration,load_duration:_.load_duration,sample_count:_.sample_count,sample_duration:_.sample_duration,prompt_eval_count:_.prompt_eval_count,prompt_eval_duration:_.prompt_eval_duration,eval_count:_.eval_count,eval_duration:_.eval_duration},t(11,r),t(1,l),s.notificationEnabled&&!document.hasFocus()){const $=new Notification(O?`${O.title.charAt(0).toUpperCase()+O.title.slice(1)}`:`${e}`,{body:a.content,icon:(O==null?void 0:O.imageUrl)??`${qe}/static/favicon.png`})}s.responseAutoCopy&&je(a.content),s.responseAutoPlayback&&(await j(),(ie=document.getElementById(`speak-button-${a.id}`))==null||ie.click())}}}catch(c){console.log(c),"detail"in c&&v.error(c.detail);break}k&&W()}d==m&&(s.saveChatHistory??!0)&&(U=await he(localStorage.token,m,{messages:r,history:l}),await de.set(await me(localStorage.token)))}else{if(T!==null){const p=await T.json();console.log(p),"detail"in p?(v.error(p.detail),a.content=p.detail):(v.error(p.error),a.content=p.error)}else v.error("Uh-oh! There was an issue connecting to Ollama."),a.content="Uh-oh! There was an issue connecting to Ollama.";a.error=!0,a.content="Uh-oh! There was an issue connecting to Ollama.",a.done=!0,t(11,r),t(1,l)}q=!1,await j(),k&&W(),r.length==2&&r.at(1).content!==""&&(window.history.replaceState(l.state,"",`/c/${m}`),await Be(m,i))},ye=async(e,i,u,m)=>{var w,E,T,re,ie,p,P,F;const a=l.messages[u];W();const f=await _t(localStorage.token,{model:e.id,stream:!0,messages:[s.system?{role:"system",content:s.system}:void 0,...r].filter(c=>c).map((c,B,_)=>{var $;return{role:c.role,...(($=c.files)==null?void 0:$.filter(H=>H.type==="image").length)>0?{content:[{type:"text",text:_.length-1!==B?c.content:(c==null?void 0:c.raContent)??c.content},...c.files.filter(H=>H.type==="image").map(H=>({type:"image_url",image_url:{url:H.url}}))]}:{content:_.length-1!==B?c.content:(c==null?void 0:c.raContent)??c.content}}}),seed:((w=s==null?void 0:s.options)==null?void 0:w.seed)??void 0,stop:((E=s==null?void 0:s.options)==null?void 0:E.stop)??void 0,temperature:((T=s==null?void 0:s.options)==null?void 0:T.temperature)??void 0,top_p:((re=s==null?void 0:s.options)==null?void 0:re.top_p)??void 0,num_ctx:((ie=s==null?void 0:s.options)==null?void 0:ie.num_ctx)??void 0,frequency_penalty:((p=s==null?void 0:s.options)==null?void 0:p.repeat_penalty)??void 0,max_tokens:((P=s==null?void 0:s.options)==null?void 0:P.num_predict)??void 0},e.source==="litellm"?`${ot}/v1`:`${st}`);if(f&&f.ok){const c=f.body.pipeThrough(new TextDecoderStream).pipeThrough(Je(`
`)).getReader();for(;;){const{value:B,done:_}=await c.read();if(_||q||m!==d){a.done=!0,t(11,r),t(1,l);break}try{let $=B.split(`
`);for(const H of $)if(H!=="")if(console.log(H),H==="data: [DONE]")a.done=!0,t(11,r),t(1,l);else{let ve=JSON.parse(H.replace(/^data: /,""));if(console.log(ve),a.content==""&&ve.choices[0].delta.content==`
`)continue;a.content+=ve.choices[0].delta.content??"",t(11,r),t(1,l)}}catch($){console.log($)}s.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:a.content,icon:`${qe}/static/favicon.png`}),s.responseAutoCopy&&je(a.content),s.responseAutoPlayback&&(await j(),(F=document.getElementById(`speak-button-${a.id}`))==null||F.click()),k&&W()}d==m&&(s.saveChatHistory??!0)&&(U=await he(localStorage.token,m,{messages:r,history:l}),await de.set(await me(localStorage.token)))}else{if(f!==null){const c=await f.json();console.log(c),"detail"in c?(v.error(c.detail),a.content=c.detail):"message"in c.error?(v.error(c.error.message),a.content=c.error.message):(v.error(c.error),a.content=c.error)}else v.error(`Uh-oh! There was an issue connecting to ${e}.`),a.content=`Uh-oh! There was an issue connecting to ${e}.`;a.error=!0,a.content=`Uh-oh! There was an issue connecting to ${e}.`,a.done=!0,t(11,r),t(1,l)}q=!1,await j(),k&&W(),r.length==2&&(window.history.replaceState(l.state,"",`/c/${m}`),await g(m,i))},le=()=>{q=!0,console.log("stopResponse")},Oe=async()=>{if(console.log("regenerateResponse"),r.length!=0&&r.at(-1).done==!0){r.splice(r.length-1,1),t(11,r),t(1,l);let e=r.at(-1),i=e.content;await ue(i,e.id)}},Re=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(d));if(r.length!=0&&r.at(-1).done==!0){const i=l.messages[l.currentId];i.done=!1,await j();const u=L.filter(m=>m.id===i.model).at(0);u&&(u!=null&&u.external?await ye(u,l.messages[i.parentId].content,i.id,e):await we(u,l.messages[i.parentId].content,i.id,e))}else v.error(`Model ${modelId} not found`)},Be=async(e,i)=>{if(s.titleAutoGenerate??!0){const u=await it(localStorage.token,(s==null?void 0:s.titleGenerationPrompt)??"Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title': {{prompt}}",(s==null?void 0:s.titleAutoGenerateModel)??h[0],i);u&&await g(e,u)}else await g(e,`${i}`)},Z=async()=>await dt(localStorage.token,d).catch(async e=>[]),Se=async e=>{await pt(localStorage.token,d,e),t(7,b=await Z()),U=await he(localStorage.token,d,{tags:b}),He.set(await We(localStorage.token))},n=async e=>{await gt(localStorage.token,d,e),t(7,b=await Z()),U=await he(localStorage.token,d,{tags:b}),He.set(await We(localStorage.token))},g=async(e,i)=>{e===d&&t(8,X=i),(s.saveChatHistory??!0)&&(U=await he(localStorage.token,e,{title:i}),await de.set(await me(localStorage.token)))};function D(e){h=e,t(0,h)}function J(e){l=e,t(1,l)}function C(e){r=e,t(11,r),t(1,l)}function G(e){k=e,t(2,k)}function x(e){z[e?"unshift":"push"](()=>{M=e,t(4,M)})}const be=e=>{t(2,k=M.scrollHeight-M.scrollTop<=M.clientHeight+50)};function Fe(e){R=e,t(10,R)}function Ye(e){V=e,t(9,V)}function ze(e){k=e,t(2,k)}return o.$$.update=()=>{if(o.$$.dirty[0]&16777217&&t(5,O=h.length===1&&A.filter(e=>e.tagName===h[0]).length>0?A.filter(e=>e.tagName===h[0])[0]:null),o.$$.dirty[0]&16777217&&t(6,ae=h.reduce((e,i,u,m)=>{var f;const a=((f=A.filter(w=>w.tagName===i))==null?void 0:f.at(0))??void 0;return{...e,...a&&{[i]:a}}},{})),o.$$.dirty[0]&2)if(l.currentId!==null){let e=[],i=l.messages[l.currentId];for(;i!==null;)e.unshift({...i}),i=i.parentId!==null?l.messages[i.parentId]:null;t(11,r=e)}else t(11,r=[])},[h,l,k,Q,M,O,ae,b,X,V,R,r,s,d,S,N,ce,_e,ue,le,Oe,Re,Se,n,A,D,J,C,G,x,be,Fe,Ye,ze]}class qt extends xe{constructor(K){super(),$e(this,K,Ct,Mt,Ke,{},null,[-1,-1])}}export{qt as component};
